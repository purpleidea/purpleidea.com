<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="James Shubin">

	<title>How to avoid cluster race conditions or: How to implement a distributed lock manager in puppet - https://purpleidea.com/</title>
	<link rel="canonical" href="https://purpleidea.com/blog/2012/08/23/how-to-avoid-cluster-race-conditions-or-how-to-implement-a-distributed-lock-manager-in-puppet/">

	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/fontawesome-all.css" rel="stylesheet">
	<link href="/css/custom.css" rel="stylesheet">
	<link href="/css/staticman.css" rel="stylesheet">


	


</head>
<body>
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
					<span class="sr-only">Toggle Navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://purpleidea.com/">purpleidea.com</a>
			</div>
			<div class="collapse navbar-collapse navbar-ex1-collapse">
				<ul class="nav navbar-nav">

					<li><a href="/about/">about</a></li>
					<li><a href="/blog/">blog</a></li>
					<li><a href="/projects/">projects</a></li>
					<li><a href="/talks/">talks</a></li>
					<li><a href="/misc/">misc</a></li>
					<li><a href="/contact/">contact</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container">

	<div class="row">
		<div class="col-md-9">
			<div class="well well-sm">
					<h3><strong>How to avoid cluster race conditions or: How to implement a distributed lock manager in puppet</strong><br><small></small></h3>
					<hr>
					<p>I&rsquo;ve been working on a puppet module for gluster. Both this, my puppet-gfs2 module, and other puppet clustering modules all share a common problem: How does one make sure that only certain operations happen on one node at a time?</p>
<p>The inelegant solutions are simple:</p>
<ol>
	<li>Specify manually (in puppet) which node the "master" is, and have it carry out all the special operations. <span style="text-decoration:underline;">Downside:</span> Single point of failure for your distributed cluster, and you've also written ugly asymmetrical code. Build a beautiful, decentralized setup instead.</li>
	<li>Run all your operations on all nodes. Ensure they're idempotent, and that they check the cluster state for success first. <span style="text-decoration:underline;">Downside:</span> Hope that they don't run simultaneously and <a href="http://en.wikipedia.org/wiki/Race_condition">race</a> somehow. This is actually how I engineered my first version of puppet-gluster! It was low risk, and I just wanted to get the cluster up; my module was just a tool, not a product.</li>
	<li>Use the built-in puppet <a href="http://en.wikipedia.org/wiki/Distributed_lock_manager">DLM</a> to coordinate running of these tasks. <span style="text-decoration:underline;">Downside:</span> Oh wait, puppet can't do this, you misunderstand the puppet architecture. I too thought this was possible for a short duration. Woops! There is no DLM.</li>
</ol>
<span style="text-decoration:underline;">Note:</span> I know this is ironic, since by default puppet requires a master node for coordination, however you <a href="http://docs.puppetlabs.com/guides/scaling_multiple_masters.html"><em>can</em></a> have multiple masters, and if they're down, puppetd still runs on the clients, it just doesn't receive new information. (You could also reconfigure your manifests to work around these downsides as they arise, but this takes the point out of puppet: keeping it automatic.)
<p>Mostly elegant: Thoughts of my other cluster crept into my head. Out of nowhere, I realized the solution was: <a href="http://en.wikipedia.org/wiki/Virtual_Router_Redundancy_Protocol">VRRP</a>! You may use a different mechanism if you like, but at the moment I&rsquo;m using <a href="http://www.keepalived.org/">keepalived</a>. Keepalived runs on my gluster pool to provide a <a href="http://en.wikipedia.org/wiki/Virtual_IP_address">VIP</a> for the cluster. This allows my clients to use a highly available IP address to download volume files (mount operation) otherwise, if that particular server were down, they wouldn&rsquo;t be about to mount. The trick: I tell each node what the expected VIP for the cluster is, and if that IP is present in a facter $ipaddress_, then I let that node execute!</p>
<p>The code is now <a href="https://github.com/purpleidea/puppet-gluster">available</a>, please have a look, and <a href="#comments">let me know</a> what you think.</p>
<p>Happy hacking,
James</p>
<p>PS: Inelegant modes 1 and 2 are still available. For mode 1, set &ldquo;vip&rdquo; in your config to the master node IP address you&rsquo;d like to use. For mode 2, leave the &ldquo;vip&rdquo; value at the empty string default.</p>
<p>PPS: I haven&rsquo;t had a change to thoroughly test this, so be warned of any dust bunnies you might find.</p>
<p><br /><i>You can <a target="_blank" href="https://m9rx.com/">hire James</a> and his team at <a target="_blank" href="https://m9rx.com/">m9rx corporation</a>.</i>

<br /><i>You can <a target="_blank" href="https://mastodon.social/@purpleidea">follow James on Mastodon</a> for more frequent updates and other random thoughts.</i>

<br /><i>You can <a target="_blank" href="https://twitter.com/intent/follow?screen_name=purpleidea">follow James on Twitter</a> for more frequent updates and other random thoughts.</i>

<br /><i>You can <a target="_blank" href="https://github.com/sponsors/purpleidea/">support James on GitHub</a> if you'd like to help sustain this kind of content.</i>

<br /><i>You can <a target="_blank" href="https://www.patreon.com/purpleidea">support James on Patreon</a> if you'd like to help sustain this kind of content.</i>
</p>

			</div>
		</div>

		
		<div class="col-md-3">
			<div class="well well-sm"> 
				<h4>August 23, 2012<br>
				<small>506 words</small></h4>
				<hr>
				<strong>Categories</strong>
				<ul class="list-unstyled">
				
					<li><a href="/categories/technical">technical</a></li>
				
				</ul>
				<hr>
				<strong>Tags</strong><br>
				<a class="label label-default" href="/tags/devops">devops</a> <a class="label label-default" href="/tags/dlm">dlm</a> <a class="label label-default" href="/tags/gluster">gluster</a> <a class="label label-default" href="/tags/keepalived">keepalived</a> <a class="label label-default" href="/tags/puppet">puppet</a> <a class="label label-default" href="/tags/vip">vip</a> <a class="label label-default" href="/tags/vrrp">vrrp</a> 
				
				<hr>
				<strong>Original URL</strong><br>
				<a href="https://ttboj.wordpress.com/2012/08/23/how-to-avoid-cluster-race-conditions-or-how-to-implement-a-distributed-lock-manager-in-puppet/"><small>https://ttboj.wordpress.com/2012/08/23/how-to-avoid-cluster-race-conditions-or-how-to-implement-a-distributed-lock-manager-in-puppet/</small></a>
				

				
			</div>
				<div class="panel panel-default">
		<div class="panel-heading" style="padding: 2px 15px;">
			<h4>Links...</h4>
		</div>
		<div class="panel-body">

			<a href="https://twitter.com/purpleidea" class="btn btn-info btn-xs"><i class="fa-brands fa-twitter-square fa-2x"></i></a>


			<a href="https://github.com/purpleidea/" class="btn btn-primary btn-xs"><i class="fa-brands fa-github-square fa-2x"></i></a>


			<a href="https://mastodon.social/@purpleidea" class="btn btn-primary btn-xs" style="background:#563ACC"><i class="fa-brands fa-mastodon fa-2x"></i></a>


	

			
		</div>
	</div>

		</div>
	</div>

	<div class="row">
		<hr>

	
<a name="comments"></a>
<section class="post-comments">
	<h3>Comments</h3>






	

	


	<p>Nothing yet.</p>

	<hr />
	<a name="comment"></a>
	<h3>Post a comment</h3>
	<form class="post-new-comment" method="POST" action="https://api.staticman.net/v2/entry/purpleidea/purpleidea.com/master/comments">
		<input type="hidden" name="options[redirect]" value="https://purpleidea.com/blog/2012/08/23/how-to-avoid-cluster-race-conditions-or-how-to-implement-a-distributed-lock-manager-in-puppet/#comment-submitted">
		<input type="hidden" name="options[entryId]" value="blog/2012/08/23/how-to-avoid-cluster-race-conditions-or-how-to-implement-a-distributed-lock-manager-in-puppet">
		<input type="hidden" name="options[reCaptcha][siteKey]" value="6Lc0u2EUAAAAAImKX7XafINIzeoLZFQCGFKF7qCp">
		<input type="hidden" name="options[reCaptcha][secret]" value="AEl4ul2uMOx2EL2LMm/84zzh8mWLYIYW&#43;v2EEu7webGOtAqyQiLBa6QLjPgnlyNjJxE3UeccxuBQIWqPzG96FsVl0AVTihhHt3OGR1hteAZUAhoJjnH&#43;7PoyC3x7d4KDLypopDn&#43;HzWowOpAZuvfHE08n&#43;G4omrP5fUfkOrH03A=">
		<div class="col-md-9">
			<div class="row">
				<textarea name="fields[message]" style="width: 80%; height: 50px;" class="post-comment-field" placeholder="Please enter your comment here..." rows="10"></textarea><br />
			</div>
			<div class="row">
				<input name="fields[name]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your name">
			</div>
			<div class="row">
				<input name="fields[email]" type="email" style="width: 50%;" class="post-comment-field" placeholder="Your email address">
			</div>
			<div class="row">
				<input name="fields[url]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your website">
			</div>
			<div class="row">
				<br />
				<div class="g-recaptcha" data-sitekey="6Lc0u2EUAAAAAImKX7XafINIzeoLZFQCGFKF7qCp"></div>
				<script src='https://www.google.com/recaptcha/api.js'></script>
				(sorry but the spammers were getting too crazy!)
			</div>
			<div class="row">
				<input type="submit" style="width: 80%;" class="post-comment-field btn btn-primary btn-xs" value="Submit">
			</div>
		</div>
	</form>
</section>

<div id="comment-submitted" class="dialog">
	<hr />
	<h3>Thank you</h3>
	<p>Your comment has been submitted and will be published if it gets approved.</p>
	<p><a href="https://github.com/purpleidea/purpleidea.com/pulls">Click here</a> to see the patch you generated.</p>
	<p><a href="#" class="btn">OK</a></p>
</div>


	</div>
		<footer>
		<div class="row">
			<hr>
			<div class="col-sm-12">
				<p>
				&copy; James Shubin 2025 &middot;
				<a href="https://purpleidea.com/">https://purpleidea.com/</a>
				
					&middot;
					<a href="https://github.com/purpleidea/purpleidea.com/blob/master/content/blog/2012/08/23/how-to-avoid-cluster-race-conditions-or-how-to-implement-a-distributed-lock-manager-in-puppet.md" style="color:grey">Edit this page</a>
				
				</p>
			</div>
		</div>
		</footer>
	</div>

	<script src="/js/jquery-1.11.3.min.js"></script>
	<script src="/js/bootstrap.js"></script>
</body>
</html>

