<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="James Shubin">

	<title>Faster golang builds - https://purpleidea.com/</title>
	<link rel="canonical" href="https://purpleidea.com/blog/2017/02/26/faster-golang-builds/">

	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/fontawesome-all.css" rel="stylesheet">
	<link href="/css/custom.css" rel="stylesheet">
	<link href="/css/staticman.css" rel="stylesheet">


	


</head>
<body>
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
					<span class="sr-only">Toggle Navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://purpleidea.com/">purpleidea.com</a>
			</div>
			<div class="collapse navbar-collapse navbar-ex1-collapse">
				<ul class="nav navbar-nav">

					<li><a href="/about/">about</a></li>
					<li><a href="/blog/">blog</a></li>
					<li><a href="/projects/">projects</a></li>
					<li><a href="/talks/">talks</a></li>
					<li><a href="/misc/">misc</a></li>
					<li><a href="/contact/">contact</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container">

	<div class="row">
		<div class="col-md-9">
			<div class="well well-sm">
					<h3><strong>Faster golang builds</strong><br><small></small></h3>
					<hr>
					<p>I&rsquo;ve been hacking in <a href="https://en.wikipedia.org/wiki/Golang">golang</a> since before version 1.4, and the speed at which my builds finished has been mostly trending downwards. Let&rsquo;s look into the reasons and some fixes. TL;DR click-bait title: &ldquo;Get 4x faster golang builds with this one trick!&rdquo;.</p>
<p>Here are the three reasons my builds got slower:</p>
<p><span style="text-decoration:underline;">The compiler</span></p>
<p>Before version 1.5, the compiler was written in C but <a href="https://golang.org/doc/go1.5#c">with that release, it moved to being pure golang</a>. This unfortunately reduced build performance quite measurably, even though it was the right decision for the project.</p>
<p>There have been slight improvements with newer versions, however Google&rsquo;s focus has been <a href="https://golang.org/doc/go1.7#compiler">improving runtime performance</a> instead of build performance. This is understandable since they want to save lots of electricity dollars at scale, which is not as helpful for smaller shops where the developer iteration cycle is the metric to optimize.</p>
<p>This could still be improved if folks wanted to put in the effort. A <a href="https://gcc.gnu.org/onlinedocs/gcc/Optimize-Options.html#Optimize-Options">gcc style -O0 option</a> could help. The sad thing about this whole story is that &ldquo;instant&rdquo; builds were a major marketing feature of early golang presentations.</p>
<p><span style="text-decoration:underline;">Project size</span></p>
<p>Over time, my <a href="https://github.com/purpleidea/mgmt/">main project (mgmt)</a> has gotten much bigger! It compiles in a number of libraries, including <a href="https://github.com/coreos/etcd">etcd</a>, <a href="https://github.com/prometheus/prometheus/">prometheus</a>, and more! This naturally increases build time and is a mostly unavoidable consequence of building cool things and <a href="https://en.wikipedia.org/wiki/Standing_on_the_shoulders_of_giants">standing on giants</a>!</p>
<p>This mostly can&rsquo;t be helped, but it can be mitigated&hellip;</p>
<p><span style="text-decoration:underline;">Dependency caching</span></p>
<p>When you build a project and all of its dependencies, the unchanged dependencies shouldn&rsquo;t need to be rebuilt! Unfortunately golang does a great job of silently rebuilding things unnecessarily. Here&rsquo;s why&hellip;</p>
<p>When you run a build, golang will attempt to re-use any common artefacts from previous builds. If the golang versions or library versions don&rsquo;t match, these won&rsquo;t be used, and the compiler will redo this work. Unfortunately, by default, those results won&rsquo;t be saved, causing you to waste CPU cycles every time you test!</p>
<p>When the intermediate results are kept, they are found in your <code>$GOPATH/pkg/</code>. To save them, you need to either run <code>go install</code> (which makes a mess in your <code>$GOPATH/bin/</code>, or you can run <strong><a href="https://github.com/purpleidea/mgmt/commit/46c6d6f6565a5e01c4fc3d7249f87a1a6a487ab8"><code>go build -i</code></a></strong>. (Thanks to <a href="https://twitter.com/davecheney/status/835772875139244032">Dave for the tip</a>!)</p>
<p>The sad part of this story is that these aren&rsquo;t cached by default, and stale results aren&rsquo;t discarded by default! If you&rsquo;re experiencing slow builds, you should <code>rm -rf $GOPATH/pkg/</code> and then <code>go build -i</code>. After one successful build, future builds should be much faster!</p>
<p><span style="text-decoration:underline;">Example</span></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>james@computer:~/code/mgmt$ time go build    # before
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>real    0m28.152s
</span></span><span style="display:flex;"><span>user    1m17.097s
</span></span><span style="display:flex;"><span>sys     0m5.235s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>james@computer:~/code/mgmt$ time go build -i    # after
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>real    0m8.129s
</span></span><span style="display:flex;"><span>user    0m12.014s
</span></span><span style="display:flex;"><span>sys     0m0.839s
</span></span></code></pre></div><p><span style="text-decoration:underline;">Debugging</span></p>
<p>If you want to debug what&rsquo;s going on, you can always run <code>go build -x</code>.</p>
<p><span style="text-decoration:underline;">Blame!</span></p>
<p>I don&rsquo;t like assigning blame, but this feels like a case of the golang tools being obtuse, and the man pages being non-existent. The golang project has a lot of maturing to do to integrate sanely with a <a href="https://fedoraproject.org/">stock</a> <a href="https://www.gnu.org/">GNU</a> environment:</p>
<ul>
    <li>build intermediates could be saved and discarded by default</li>
    <li><code>man go build</code> could exist and provide useful information</li>
    <li><del><code>go build --help</code></del> <code>go help build</code> could provide more useful information</li>
    <li>POSIX style flags could be used (eg: <code>--help</code>)</li>
    <li>build cache could be stored in <a href="https://standards.freedesktop.org/basedir-spec/basedir-spec-latest.html#variables"><code>$XDG_CACHE_HOME</code></a>.</li>
</ul>
<p>Hope this helped improve your golang experience! I always knew something was going in in <code>$GOPATH/pkg/</code>, but I think it&rsquo;s pretty absurd that I only fully understood it now. My builds are about 4x faster now. :)</p>
<p>Happy Hacking,</p>
<p>James</p>
<p><br /><i>You can <a target="_blank" href="https://m9rx.com/">hire James</a> and his team at <a target="_blank" href="https://m9rx.com/">m9rx corporation</a>.</i>

<br /><i>You can <a target="_blank" href="https://mastodon.social/@purpleidea">follow James on Mastodon</a> for more frequent updates and other random thoughts.</i>

<br /><i>You can <a target="_blank" href="https://twitter.com/intent/follow?screen_name=purpleidea">follow James on Twitter</a> for more frequent updates and other random thoughts.</i>

<br /><i>You can <a target="_blank" href="https://github.com/sponsors/purpleidea/">support James on GitHub</a> if you'd like to help sustain this kind of content.</i>

<br /><i>You can <a target="_blank" href="https://www.patreon.com/purpleidea">support James on Patreon</a> if you'd like to help sustain this kind of content.</i>
</p>

			</div>
		</div>

		
		<div class="col-md-3">
			<div class="well well-sm"> 
				<h4>February 26, 2017<br>
				<small>646 words</small></h4>
				<hr>
				<strong>Categories</strong>
				<ul class="list-unstyled">
				
					<li><a href="/categories/technical">technical</a></li>
				
				</ul>
				<hr>
				<strong>Tags</strong><br>
				<a class="label label-default" href="/tags/gopath">$GOPATH</a> <a class="label label-default" href="/tags/gnu">GNU</a> <a class="label label-default" href="/tags/xdg">XDG</a> <a class="label label-default" href="/tags/devops">devops</a> <a class="label label-default" href="/tags/etcd">etcd</a> <a class="label label-default" href="/tags/fedora">fedora</a> <a class="label label-default" href="/tags/gcc">gcc</a> <a class="label label-default" href="/tags/gluster">gluster</a> <a class="label label-default" href="/tags/go-build">go build</a> <a class="label label-default" href="/tags/golang">golang</a> <a class="label label-default" href="/tags/mgmtconfig">mgmtconfig</a> <a class="label label-default" href="/tags/planetdevops">planetdevops</a> <a class="label label-default" href="/tags/planetfedora">planetfedora</a> <a class="label label-default" href="/tags/posix">posix</a> <a class="label label-default" href="/tags/prometheus">prometheus</a> 
				
				<hr>
				<strong>Original URL</strong><br>
				<a href="https://ttboj.wordpress.com/2017/02/26/faster-golang-builds/"><small>https://ttboj.wordpress.com/2017/02/26/faster-golang-builds/</small></a>
				

				
			</div>
				<div class="panel panel-default">
		<div class="panel-heading" style="padding: 2px 15px;">
			<h4>Links...</h4>
		</div>
		<div class="panel-body">

			<a href="https://twitter.com/purpleidea" class="btn btn-info btn-xs"><i class="fa-brands fa-twitter-square fa-2x"></i></a>


			<a href="https://github.com/purpleidea/" class="btn btn-primary btn-xs"><i class="fa-brands fa-github-square fa-2x"></i></a>


			<a href="https://mastodon.social/@purpleidea" class="btn btn-primary btn-xs" style="background:#563ACC"><i class="fa-brands fa-mastodon fa-2x"></i></a>


	

			
		</div>
	</div>

		</div>
	</div>

	<div class="row">
		<hr>

	
<a name="comments"></a>
<section class="post-comments">
	<h3>Comments</h3>






	

	


	<p>Nothing yet.</p>

	<hr />
	<a name="comment"></a>
	<h3>Post a comment</h3>
	<form class="post-new-comment" method="POST" action="https://api.staticman.net/v2/entry/purpleidea/purpleidea.com/master/comments">
		<input type="hidden" name="options[redirect]" value="https://purpleidea.com/blog/2017/02/26/faster-golang-builds/#comment-submitted">
		<input type="hidden" name="options[entryId]" value="blog/2017/02/26/faster-golang-builds">
		<input type="hidden" name="options[reCaptcha][siteKey]" value="6Lc0u2EUAAAAAImKX7XafINIzeoLZFQCGFKF7qCp">
		<input type="hidden" name="options[reCaptcha][secret]" value="AEl4ul2uMOx2EL2LMm/84zzh8mWLYIYW&#43;v2EEu7webGOtAqyQiLBa6QLjPgnlyNjJxE3UeccxuBQIWqPzG96FsVl0AVTihhHt3OGR1hteAZUAhoJjnH&#43;7PoyC3x7d4KDLypopDn&#43;HzWowOpAZuvfHE08n&#43;G4omrP5fUfkOrH03A=">
		<div class="col-md-9">
			<div class="row">
				<textarea name="fields[message]" style="width: 80%; height: 50px;" class="post-comment-field" placeholder="Please enter your comment here..." rows="10"></textarea><br />
			</div>
			<div class="row">
				<input name="fields[name]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your name">
			</div>
			<div class="row">
				<input name="fields[email]" type="email" style="width: 50%;" class="post-comment-field" placeholder="Your email address">
			</div>
			<div class="row">
				<input name="fields[url]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your website">
			</div>
			<div class="row">
				<br />
				<div class="g-recaptcha" data-sitekey="6Lc0u2EUAAAAAImKX7XafINIzeoLZFQCGFKF7qCp"></div>
				<script src='https://www.google.com/recaptcha/api.js'></script>
				(sorry but the spammers were getting too crazy!)
			</div>
			<div class="row">
				<input type="submit" style="width: 80%;" class="post-comment-field btn btn-primary btn-xs" value="Submit">
			</div>
		</div>
	</form>
</section>

<div id="comment-submitted" class="dialog">
	<hr />
	<h3>Thank you</h3>
	<p>Your comment has been submitted and will be published if it gets approved.</p>
	<p><a href="https://github.com/purpleidea/purpleidea.com/pulls">Click here</a> to see the patch you generated.</p>
	<p><a href="#" class="btn">OK</a></p>
</div>


	</div>
		<footer>
		<div class="row">
			<hr>
			<div class="col-sm-12">
				<p>
				&copy; James Shubin 2025 &middot;
				<a href="https://purpleidea.com/">https://purpleidea.com/</a>
				
					&middot;
					<a href="https://github.com/purpleidea/purpleidea.com/blob/master/content/blog/2017/02/26/faster-golang-builds.md" style="color:grey">Edit this page</a>
				
				</p>
			</div>
		</div>
		</footer>
	</div>

	<script src="/js/jquery-1.11.3.min.js"></script>
	<script src="/js/bootstrap.js"></script>
</body>
</html>

