<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="description" content="">
	<meta name="author" content="James Shubin">

	<title>IPVS &#43; shorewall - https://purpleidea.com/</title>
	<link rel="canonical" href="https://purpleidea.com/blog/2009/11/05/ipvs-shorewall/">

	<link href="/css/bootstrap.min.css" rel="stylesheet">
	<link href="/css/fontawesome-all.css" rel="stylesheet">
	<link href="/css/custom.css" rel="stylesheet">
	<link href="/css/staticman.css" rel="stylesheet">


	


</head>
<body>
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation">
		<div class="container">
			<div class="navbar-header">
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-ex1-collapse">
					<span class="sr-only">Toggle Navigation</span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
				<a class="navbar-brand" href="https://purpleidea.com/">purpleidea.com</a>
			</div>
			<div class="collapse navbar-collapse navbar-ex1-collapse">
				<ul class="nav navbar-nav">

					<li><a href="/about/">about</a></li>
					<li><a href="/blog/">blog</a></li>
					<li><a href="/projects/">projects</a></li>
					<li><a href="/talks/">talks</a></li>
					<li><a href="/misc/">misc</a></li>
					<li><a href="/contact/">contact</a></li>
				</ul>
			</div>
		</div>
	</nav>

	<div class="container">

	<div class="row">
		<div class="col-md-9">
			<div class="well well-sm">
					<h3><strong>IPVS &#43; shorewall</strong><br><small></small></h3>
					<hr>
					<p><a href="http://www.linuxvirtualserver.org/">lvs</a> load balancing always felt like an elusive task. here i will document how to get it working with the excellent <a href="http://www.shorewall.net/">shorewall</a> firewall, as an extension to their <a href="http://www.shorewall.net/two-interface.htm">two interface</a> common use case. this was all necessary for a group of grad students that needed to test out and develop some distributed algorithms. it turns out that once you get going, all this is quite easy and fun!</p>
<p>the various components and files used for this setup include:</p>
<ul>
	<li><span style="background-color:#ffffff;">a dhcp server: /etc/dhcp3/dhcpd.conf</span></li>
	<li><span style="background-color:#ffffff;">shorewall:Â /etc/shorewall/*</span></li>
	<li><span style="background-color:#ffffff;">hosts file: /etc/hosts</span></li>
	<li><span style="background-color:#ffffff;">networking: /etc/network/interfaces</span></li>
	<li><span style="background-color:#ffffff;">ipvs/ipvsadm</span></li>
</ul>
let's get going. first setup the head node. for networking, you'll need a public ip and a private one. in my case /etc/network/interfaces looks like this:
```
# The loopback network interface
auto lo
iface lo inet loopback
```
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span># The primary network interface (public)
</span></span><span style="display:flex;"><span>auto eth1
</span></span><span style="display:flex;"><span>iface eth1 inet static
</span></span><span style="display:flex;"><span>address 123.321.52.210
</span></span><span style="display:flex;"><span>netmask 255.255.255.0
</span></span><span style="display:flex;"><span>network 123.321.52.0
</span></span><span style="display:flex;"><span>broadcast 123.321.52.255
</span></span><span style="display:flex;"><span>gateway 123.321.52.253
</span></span><span style="display:flex;"><span># dns-* options are implemented by the resolvconf package, if installed
</span></span><span style="display:flex;"><span>dns-nameservers 123.321.52.1 123.321.52.3
</span></span><span style="display:flex;"><span>dns-search something.example.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span># The private lan
</span></span><span style="display:flex;"><span>auto eth0
</span></span><span style="display:flex;"><span>iface eth0 inet static
</span></span><span style="display:flex;"><span>address 192.168.1.254
</span></span><span style="display:flex;"><span>netmask 255.255.255.0
</span></span></code></pre></div><p>you&rsquo;ll notice that in the two interface default shorewall config, my eth0 is their eth1 and vice-versa. also, i&rsquo;ve replaced my hostname and ip block with something invented. sorry! anyways, the tail of dhcpd.conf looks like this:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>option subnet-mask 255.255.255.0;
</span></span><span style="display:flex;"><span>option broadcast-address 192.168.1.255;
</span></span><span style="display:flex;"><span>option routers 192.168.1.254;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>subnet 192.168.1.0 netmask 255.255.255.0 {
</span></span><span style="display:flex;"><span>        #range 192.168.1.10 192.168.1.100;
</span></span><span style="display:flex;"><span>        host node1 {
</span></span><span style="display:flex;"><span>                hardware ethernet 00:12:34:56:78:91;
</span></span><span style="display:flex;"><span>                fixed-address 192.168.1.101;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        host node2 {
</span></span><span style="display:flex;"><span>                hardware ethernet 00:12:34:56:78:92;
</span></span><span style="display:flex;"><span>                fixed-address 192.168.1.102;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>next to make it easier for myself to reference the nodes i&rsquo;ll setup /etc/hosts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>123.321.52.210  node.something.example.com       node
</span></span><span style="display:flex;"><span>192.168.1.101   node1
</span></span><span style="display:flex;"><span>192.168.1.102   node2
</span></span></code></pre></div><p>shorewall comes next. use the default two-interface setup, and add the following entries in /etc/shorewall/rules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ACCEPT          net             $FW                     tcp     8000
</span></span><span style="display:flex;"><span>ACCEPT          $FW             loc                     tcp     8000
</span></span></code></pre></div><p>i&rsquo;ve decided i want to distribute port 8000. to make it easier for ipvs to figure out which packets should get load balanced, we can mark them with /etc/shorewall/tcrules:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>1       0.0.0.0/0       132.206.52.210  tcp     8000
</span></span></code></pre></div><p>which marks them with integer: &ldquo;1&rdquo;. lastly for ipvs, edit /etc/sysctl.conf, and add:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>net.ipv4.ip_forward = 1
</span></span></code></pre></div><p>let the kernel know with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>sysctl -p
</span></span></code></pre></div><p>and then tell ipvs what is going on with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>ipvsadm -A -f 1 -s rr
</span></span><span style="display:flex;"><span>ipvsadm -a -f 1 -r node1:8000 -m
</span></span><span style="display:flex;"><span>ipvsadm -a -f 1 -r node2:8000 -m
</span></span></code></pre></div><p>the various flags are well documented in the ipvsadm man page and are self explanatory here. you can test this all out by running something at the two nodes, i used:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>python -m SimpleHTTPServer
</span></span></code></pre></div><p>which serves the current directory with a text file named &ldquo;NODE1&rdquo; and &ldquo;NODE2&rdquo; respective to the node, and i tested that the requests alternate by pointing my browser to the head node at port 8000.</p>
<p>i hope this meets everyones needs for documentation and knowledge; i couldn&rsquo;t have done this without great ipvs <a href="http://www.ultramonkey.org/papers/lvs_tutorial/">reference</a> or the amazing <a href="http://shorewall.net/">shorewall</a>.</p>
<p><br /><i>You can <a target="_blank" href="https://m9rx.com/">hire James</a> and his team at <a target="_blank" href="https://m9rx.com/">m9rx corporation</a>.</i>

<br /><i>You can <a target="_blank" href="https://mastodon.social/@purpleidea">follow James on Mastodon</a> for more frequent updates and other random thoughts.</i>

<br /><i>You can <a target="_blank" href="https://twitter.com/intent/follow?screen_name=purpleidea">follow James on Twitter</a> for more frequent updates and other random thoughts.</i>

<br /><i>You can <a target="_blank" href="https://github.com/sponsors/purpleidea/">support James on GitHub</a> if you'd like to help sustain this kind of content.</i>

<br /><i>You can <a target="_blank" href="https://www.patreon.com/purpleidea">support James on Patreon</a> if you'd like to help sustain this kind of content.</i>
</p>

			</div>
		</div>

		
		<div class="col-md-3">
			<div class="well well-sm"> 
				<h4>November 5, 2009<br>
				<small>548 words</small></h4>
				<hr>
				<strong>Categories</strong>
				<ul class="list-unstyled">
				
					<li><a href="/categories/technical">technical</a></li>
				
				</ul>
				<hr>
				<strong>Tags</strong><br>
				
				
				<hr>
				<strong>Original URL</strong><br>
				<a href="https://ttboj.wordpress.com/2009/11/05/ipvs-shorewall/"><small>https://ttboj.wordpress.com/2009/11/05/ipvs-shorewall/</small></a>
				

				
			</div>
				<div class="panel panel-default">
		<div class="panel-heading" style="padding: 2px 15px;">
			<h4>Links...</h4>
		</div>
		<div class="panel-body">

			<a href="https://twitter.com/purpleidea" class="btn btn-info btn-xs"><i class="fa-brands fa-twitter-square fa-2x"></i></a>


			<a href="https://github.com/purpleidea/" class="btn btn-primary btn-xs"><i class="fa-brands fa-github-square fa-2x"></i></a>


			<a href="https://mastodon.social/@purpleidea" class="btn btn-primary btn-xs" style="background:#563ACC"><i class="fa-brands fa-mastodon fa-2x"></i></a>


	

			
		</div>
	</div>

		</div>
	</div>

	<div class="row">
		<hr>

	
<a name="comments"></a>
<section class="post-comments">
	<h3>Comments</h3>






	

	


	<p>Nothing yet.</p>

	<hr />
	<a name="comment"></a>
	<h3>Post a comment</h3>
	<form class="post-new-comment" method="POST" action="https://api.staticman.net/v2/entry/purpleidea/purpleidea.com/master/comments">
		<input type="hidden" name="options[redirect]" value="https://purpleidea.com/blog/2009/11/05/ipvs-shorewall/#comment-submitted">
		<input type="hidden" name="options[entryId]" value="blog/2009/11/05/ipvs-shorewall">
		<input type="hidden" name="options[reCaptcha][siteKey]" value="6Lc0u2EUAAAAAImKX7XafINIzeoLZFQCGFKF7qCp">
		<input type="hidden" name="options[reCaptcha][secret]" value="AEl4ul2uMOx2EL2LMm/84zzh8mWLYIYW&#43;v2EEu7webGOtAqyQiLBa6QLjPgnlyNjJxE3UeccxuBQIWqPzG96FsVl0AVTihhHt3OGR1hteAZUAhoJjnH&#43;7PoyC3x7d4KDLypopDn&#43;HzWowOpAZuvfHE08n&#43;G4omrP5fUfkOrH03A=">
		<div class="col-md-9">
			<div class="row">
				<textarea name="fields[message]" style="width: 80%; height: 50px;" class="post-comment-field" placeholder="Please enter your comment here..." rows="10"></textarea><br />
			</div>
			<div class="row">
				<input name="fields[name]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your name">
			</div>
			<div class="row">
				<input name="fields[email]" type="email" style="width: 50%;" class="post-comment-field" placeholder="Your email address">
			</div>
			<div class="row">
				<input name="fields[url]" type="text" style="width: 50%;" class="post-comment-field" placeholder="Your website">
			</div>
			<div class="row">
				<br />
				<div class="g-recaptcha" data-sitekey="6Lc0u2EUAAAAAImKX7XafINIzeoLZFQCGFKF7qCp"></div>
				<script src='https://www.google.com/recaptcha/api.js'></script>
				(sorry but the spammers were getting too crazy!)
			</div>
			<div class="row">
				<input type="submit" style="width: 80%;" class="post-comment-field btn btn-primary btn-xs" value="Submit">
			</div>
		</div>
	</form>
</section>

<div id="comment-submitted" class="dialog">
	<hr />
	<h3>Thank you</h3>
	<p>Your comment has been submitted and will be published if it gets approved.</p>
	<p><a href="https://github.com/purpleidea/purpleidea.com/pulls">Click here</a> to see the patch you generated.</p>
	<p><a href="#" class="btn">OK</a></p>
</div>


	</div>
		<footer>
		<div class="row">
			<hr>
			<div class="col-sm-12">
				<p>
				&copy; James Shubin 2025 &middot;
				<a href="https://purpleidea.com/">https://purpleidea.com/</a>
				
					&middot;
					<a href="https://github.com/purpleidea/purpleidea.com/blob/master/content/blog/2009/11/05/ipvs-shorewall.md" style="color:grey">Edit this page</a>
				
				</p>
			</div>
		</div>
		</footer>
	</div>

	<script src="/js/jquery-1.11.3.min.js"></script>
	<script src="/js/bootstrap.js"></script>
</body>
</html>

